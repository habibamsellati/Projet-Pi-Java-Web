{% extends 'base.back.html.twig' %}

{% block title %}Visioconf√©rence - R√©clamation #{{ reclamation.id }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .video-call-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 1.5rem;
            padding: 1.5rem;
        }
        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }
        .video-info h2 {
            font-size: 1.3rem;
            color: #2d7a4f;
            margin: 0 0 0.3rem 0;
        }
        .video-info p {
            font-size: 0.9rem;
            color: #666;
            margin: 0;
        }
        .exit-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .exit-button:hover {
            background: #c82333;
        }
        .video-wrapper {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            background: #1a1a1a;
        }
        #jitsi-meet {
            width: 100%;
            height: 100%;
        }
        .back-link {
            display: inline-block;
            color: #8b5e4a;
            text-decoration: none;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
{% endblock %}

{% block back_main %}
    <header class="header">
        <div class="header-left">
            <h1>Visioconf√©rence</h1>
        </div>
    </header>

    <a href="{{ path('back_reclamation_show', {'id': reclamation.id}) }}" class="back-link">‚Üê Retour √† la r√©clamation</a>

    <div class="video-call-container">
        <div class="video-header">
            <div class="video-info">
                <h2>üìπ R√©clamation #{{ reclamation.id }}</h2>
                <p>{{ reclamation.titre }}</p>
            </div>
            <button class="exit-button" onclick="exitCall()">‚úï Quitter l'appel</button>
        </div>

        <div class="video-wrapper">
            <div id="jitsi-meet"></div>
        </div>
    </div>

    <script src='https://meet.jit.si/external_api.js'></script>
    <script>
        const domain = 'meet.jit.si';
        const options = {
            roomName: '{{ roomId }}',
            width: '100%',
            height: '100%',
            parentNode: document.querySelector('#jitsi-meet'),
            userInfo: {
                displayName: '{{ displayName }}'
            },
            configOverwrite: {
                startWithAudioMuted: false,
                startWithVideoMuted: false,
                prejoinPageEnabled: false,
                disableDeepLinking: true
            },
            interfaceConfigOverwrite: {
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false,
                SHOW_BRAND_WATERMARK: false,
                BRAND_WATERMARK_LINK: '',
                DEFAULT_BACKGROUND: '#1a1a1a',
                DISABLE_JOIN_LEAVE_NOTIFICATIONS: false,
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                    'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                    'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                    'videoquality', 'filmstrip', 'feedback', 'stats', 'shortcuts',
                    'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone'
                ]
            }
        };

        const api = new JitsiMeetExternalAPI(domain, options);

        // Handle when user leaves the call
        api.addEventListener('readyToClose', () => {
            exitCall();
        });

        function exitCall() {
            if (confirm('√ätes-vous s√ªr de vouloir quitter la visioconf√©rence ?')) {
                window.location.href = '{{ path('back_reclamation_show', {'id': reclamation.id}) }}';
            }
        }
    </script>
{% endblock %}
