{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('Assets/css/back.css') }}">
{% endblock %}

{% block body %}
<div class="admin-container {% block admin_container_class %}{% endblock %}">
    {% include 'partials/_sidebar_back.html.twig' %}
    <main class="main-content">
        {% block back_main %}{% endblock %}
    </main>
</div>
{% include 'partials/_modals_back.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
    (function() {
        var btnGoFront = document.getElementById('btn-go-front');
        var frontModal = document.getElementById('frontModal');
        var frontModalClose = document.getElementById('frontModalClose');
        var frontCancel = document.getElementById('frontCancel');
        if (btnGoFront) {
            btnGoFront.addEventListener('click', function(e) {
                e.preventDefault();
                frontModal.style.display = 'flex';
                document.getElementById('frontPassword').focus();
            });
        }
        if (frontModalClose) frontModalClose.addEventListener('click', function() { frontModal.style.display = 'none'; });
        if (frontCancel) frontCancel.addEventListener('click', function() { frontModal.style.display = 'none'; });
        window.addEventListener('click', function(e) {
            if (e.target === frontModal) frontModal.style.display = 'none';
        });

        var sidebarLinks = document.querySelectorAll('.sidebar a[href]');
        var responsableModalEl = document.getElementById('responsableModal');
        var responsableForm = document.getElementById('responsableAccessForm');
        var responsableModuleInput = document.getElementById('responsableModule');
        var responsableTitle = document.getElementById('responsableModalTitle');
        var responsableDesc = document.getElementById('responsableModalDesc');
        var responsableError = document.getElementById('responsableModalError');
        var responsableClose = document.querySelector('#responsableModal .modal-access-close');
        var responsableCancel = document.getElementById('responsableCancel');
        var pendingHref = '';
        var moduleLabels = {
            produit_recyclable: 'Responsable Produit Recyclable',
            proposition: 'Responsable Proposition',
            reservation: 'Responsable Reservation',
            suivi_livraison: 'Responsable Suivi Livraison',
            livraison: 'Responsable Livraison',
            commande: 'Responsable Commande',
            reclamation: 'Responsable Reclamation',
            article: 'Responsable Article',
            evenement: 'Responsable Evenement'
        };

        function openResponsableModal(module, label, href) {
            responsableModuleInput.value = module;
            responsableTitle.textContent = label || 'Acces responsable';
            responsableDesc.textContent = 'Veuillez saisir les identifiants du responsable.';
            responsableError.textContent = '';
            pendingHref = href || '#';
            responsableModalEl.style.display = 'flex';
            document.getElementById('responsableUsername').focus();
        }
        function closeResponsableModal() {
            responsableModalEl.style.display = 'none';
            responsableForm.reset();
            responsableError.textContent = '';
        }

        function resolveModule(link, module) {
            var href = (link.getAttribute('href') || '').toLowerCase();
            if (href.indexOf('/back/propositions') !== -1) return 'proposition';
            if (href.indexOf('/back/reservations') !== -1 || href.indexOf('/back/reservation') !== -1) return 'reservation';
            if (href.indexOf('/back/suivi-livraisons') !== -1 || href.indexOf('/back/suivi-livraison') !== -1) return 'suivi_livraison';
            if (href.indexOf('/back/produits') !== -1 || href.indexOf('/back/produit') !== -1) return 'produit_recyclable';
            if (href.indexOf('/back/livraisons') !== -1 || href.indexOf('/back/livraison') !== -1) return 'livraison';
            if (href.indexOf('/back/commandes') !== -1) return 'commande';
            if (href.indexOf('/back/reclamations') !== -1) return 'reclamation';
            if (href.indexOf('/back/articles') !== -1) return 'article';
            if (href.indexOf('/back/evenements') !== -1) return 'evenement';
            return module;
        }

        [].forEach.call(sidebarLinks, function(link) {
            link.addEventListener('click', function(e) {
                var module = this.getAttribute('data-responsable');
                module = resolveModule(this, module);
                if (!module) return;
                e.preventDefault();
                var label = moduleLabels[module] || this.getAttribute('data-responsable-label') || 'Acces responsable';
                openResponsableModal(module, label, this.getAttribute('href'));
            });
        });
        if (responsableClose) responsableClose.addEventListener('click', closeResponsableModal);
        if (responsableCancel) responsableCancel.addEventListener('click', closeResponsableModal);
        window.addEventListener('click', function(e) {
            if (e.target === responsableModalEl) closeResponsableModal();
        });

        if (responsableForm) {
            responsableForm.addEventListener('submit', function(e) {
                e.preventDefault();
                responsableError.textContent = '';
                var formData = new FormData(responsableForm);
                fetch('{{ path('back_access_verify') }}', { method: 'POST', body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (!data.ok) {
                            responsableError.textContent = data.message || 'Acces refus√©';
                            return;
                        }
                        closeResponsableModal();
                        if (pendingHref && pendingHref !== '#') window.location.href = pendingHref;
                    })
                    .catch(function() { responsableError.textContent = 'Erreur lors de la verification'; });
            });
        }
    })();
    </script>
    <script>
    (function() {
        function ensureEyeStyles() {
            if (document.getElementById('back-password-eye-style')) return;
            var style = document.createElement('style');
            style.id = 'back-password-eye-style';
            style.textContent = [
                '.pwd-eye-wrap{position:relative;}',
                '.pwd-eye-wrap input[type="password"], .pwd-eye-wrap input[type="text"]{width:100%;padding-right:3rem;}',
                '.pwd-eye-btn{position:absolute;right:.6rem;top:50%;transform:translateY(-50%);width:2rem;height:2rem;border-radius:999px;border:1px solid #e7ddd1;background:linear-gradient(135deg,#fff,#f7efe5);color:#C4704B;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease;}',
                '.pwd-eye-btn:hover{transform:translateY(-50%) scale(1.05);border-color:#d4b598;box-shadow:0 6px 14px rgba(196,112,75,.2);}',
                '.pwd-eye-btn svg{width:1rem;height:1rem;}'
            ].join('');
            document.head.appendChild(style);
        }

        function makeToggleForInput(input) {
            if (!input || input.dataset.eyeReady === '1') return;
            input.dataset.eyeReady = '1';

            var wrapper = document.createElement('div');
            wrapper.className = 'pwd-eye-wrap';
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);

            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'pwd-eye-btn';
            btn.setAttribute('aria-label', 'Afficher le mot de passe');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path class="eye-shape" d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.8"></circle></svg>';
            wrapper.appendChild(btn);

            btn.addEventListener('click', function() {
                var show = input.type === 'password';
                input.type = show ? 'text' : 'password';
                btn.setAttribute('aria-label', show ? 'Masquer le mot de passe' : 'Afficher le mot de passe');
                var eye = btn.querySelector('.eye-shape');
                if (eye) {
                    eye.setAttribute('d', show
                        ? 'M3 3l18 18M2 12s3.5-6 10-6c2.2 0 4.1.7 5.7 1.7M22 12s-3.5 6-10 6c-2.2 0-4.1-.7-5.7-1.7'
                        : 'M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6Z');
                }
            });
        }

        function applyToAllPasswordInputs() {
            ensureEyeStyles();
            document.querySelectorAll('input[type="password"]').forEach(makeToggleForInput);
        }

        document.addEventListener('DOMContentLoaded', function() {
            applyToAllPasswordInputs();

            // Back-office modals are injected/opened dynamically; observe future password fields.
            var observer = new MutationObserver(function() {
                applyToAllPasswordInputs();
            });
            observer.observe(document.body, { childList: true, subtree: true });
        });
    })();
    </script>
{% endblock %}
