{# templates/components/_ai_concierge.html.twig #}
<div id="ai-concierge-container" style="position: fixed; bottom: 30px; right: 30px; z-index: 9999; font-family: 'Outfit', sans-serif;">
    
    {# Floating Trigger Button #}
    <button id="ai-trigger" style="width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(135deg, #2b2b2b 0%, #C4704B 100%); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(196, 112, 75, 0.3); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative;">
        <svg id="chat-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <svg id="close-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        <span style="position: absolute; top: -5px; right: -5px; width: 15px; height: 15px; background: #4ADE80; border: 3px solid white; border-radius: 50%;"></span>
    </button>

    {# Chat Window #}
    <div id="ai-window" style="display: none; position: absolute; bottom: 85px; right: 0; width: 380px; height: 550px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 20px 60px rgba(0,0,0,0.15); flex-direction: column; overflow: hidden; transform-origin: bottom right; animation: scaleUp 0.3s ease-out;">
        
        {# Header #}
        <div style="padding: 25px; background: linear-gradient(135deg, rgba(43,43,43,0.05) 0%, rgba(196,112,75,0.08) 100%); border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px;">
            <div style="width: 45px; height: 45px; border-radius: 12px; background: #C4704B; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">âœ¨</div>
            <div>
                <h4 style="margin: 0; font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; color: #2b2b2b;">Concierge AfkArt</h4>
                <p style="margin: 0; font-size: 0.75rem; color: #4ade80; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">En ligne â€¢ Expert IA</p>
            </div>
        </div>

        {# Messages Area #}
        <div id="ai-messages" style="flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth;">
            <div class="ai-msg bot" style="background: rgba(43,43,43,0.05); padding: 15px 20px; border-radius: 20px 20px 20px 5px; max-width: 85%; align-self: flex-start; font-size: 0.95rem; line-height: 1.5; color: #2b2b2b;">
                Bonjour ! Je suis votre guide culturel AfkArt. Je connais tous nos artisans et Ã©vÃ©nements sur le bout des doigts. Comment puis-je vous inspirer aujourd'hui ? ðŸŽ­
            </div>
        </div>

        {# Input Area #}
        <div style="padding: 20px; border-top: 1px solid rgba(0,0,0,0.05); background: white;">
            <div style="display: flex; gap: 10px; background: #f8f8f8; padding: 8px 15px; border-radius: 15px; border: 1.5px solid #eee; transition: all 0.3s;" id="input-container">
                <input type="text" id="ai-input" placeholder="Demandez-moi un conseil..." style="flex: 1; background: transparent; border: none; outline: none; padding: 10px 0; font-family: 'Outfit', sans-serif; font-size: 0.95rem;">
                <button id="ai-send" style="background: #2b2b2b; color: white; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

</div>

<style>
    @keyframes scaleUp {
        from { transform: scale(0.8) translateY(20px); opacity: 0; }
        to { transform: scale(1) translateY(0); opacity: 1; }
    }
    #ai-trigger:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 40px rgba(196, 112, 75, 0.4);
    }
    .user-msg {
        background: #C4704B;
        color: white !important;
        border-radius: 20px 20px 5px 20px !important;
        align-self: flex-end !important;
        box-shadow: 0 5px 15px rgba(196, 112, 75, 0.15);
    }
    #ai-messages::-webkit-scrollbar { width: 4px; }
    #ai-messages::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const trigger = document.getElementById('ai-trigger');
    const window = document.getElementById('ai-window');
    const input = document.getElementById('ai-input');
    const send = document.getElementById('ai-send');
    const messages = document.getElementById('ai-messages');
    const chatIcon = document.getElementById('chat-icon');
    const closeIcon = document.getElementById('close-icon');

    trigger.addEventListener('click', () => {
        const isOpen = window.style.display === 'flex';
        window.style.display = isOpen ? 'none' : 'flex';
        chatIcon.style.display = isOpen ? 'block' : 'none';
        closeIcon.style.display = isOpen ? 'none' : 'block';
        if(!isOpen) input.focus();
    });

    function addMessage(text, type) {
        const msg = document.createElement('div');
        msg.className = `ai-msg ${type}`;
        msg.style.cssText = type === 'bot' 
            ? "background: rgba(43,43,43,0.05); padding: 15px 20px; border-radius: 20px 20px 20px 5px; max-width: 85%; align-self: flex-start; font-size: 0.95rem; line-height: 1.5; color: #2b2b2b;"
            : "background: #C4704B; color: white !important; padding: 15px 20px; border-radius: 20px 20px 5px 20px; max-width: 85%; align-self: flex-end; font-size: 0.95rem; line-height: 1.5;";
        
        msg.innerText = text;
        messages.appendChild(msg);
        messages.scrollTop = messages.scrollHeight;
    }

    async function handleSend() {
        const text = input.value.trim();
        if (!text) return;

        input.value = '';
        addMessage(text, 'user');

        // Loading state
        const loading = document.createElement('div');
        loading.innerHTML = 'En train de rÃ©flÃ©chir...';
        loading.style.fontSize = '0.8rem';
        loading.style.color = '#888';
        loading.style.padding = '5px 10px';
        messages.appendChild(loading);
        messages.scrollTop = messages.scrollHeight;

        try {
            const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await response.json();
            messages.removeChild(loading);
            addMessage(data.response || "DÃ©solÃ©, j'ai eu une petite absence.", 'bot');
        } catch (e) {
            messages.removeChild(loading);
            addMessage("Oups, ma connexion s'est brouillÃ©e. RÃ©essayez ?", 'bot');
        }
    }

    send.addEventListener('click', handleSend);
    input.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
});
</script>
