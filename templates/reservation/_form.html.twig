{% if reservation is defined and reservation.id and reservation.createdAt %}
    {% set expiry = reservation.createdAt|date_modify("+3 hours") %}
    {% set now_u = "now"|date("U") %}
    {% set expiry_u = expiry|date("U") %}
    {% set diff = expiry_u - now_u %}
    <div style="margin-bottom: 1.5rem; padding: 1.25rem; border-radius: 12px; background: {% if diff > 0 %}#fefce8{% else %}#fff1f2{% endif %}; border: 1px solid {% if diff > 0 %}#fef08a{% else %}#fecdd3{% endif %};">
        <h5 style="margin: 0 0 0.5rem 0; color: {% if diff > 0 %}#854d0e{% else %}#991b1b{% endif %}; display: flex; align-items: center; gap: 0.5rem;">
            {% if diff > 0 %}⏱️ Délai de confirmation{% else %}⚠️ Délai expiré{% endif %}
        </h5>
        <p style="margin: 0; font-size: 0.9rem; color: #5C4A3D;">
            {% if diff > 0 %}
                Vous avez jusqu'au <strong>{{ expiry|date('d/m/Y H:i:s') }}</strong> pour confirmer ou modifier cette réservation.
                Temps restant : <strong><span id="reservation-timer">{{ (diff // 3600) }}h {{ (diff % 3600 // 60) }}m</span></strong>.
            {% else %}
                Le délai de 3 heures est dépassé. Toute modification vers le statut « Confirmé » sera rejetée.
                {% if reservation.statut == 'annule' %}
                    <br><span style="color: #991b1b; font-weight: 600;">Cette réservation a été annulée suite au dépassement du délai.</span>
                {% endif %}
            {% endif %}
        </p>
    </div>
    {% if diff > 0 %}
    <script>
    (function() {
        var expiryU = {{ expiry_u }};
        function updateTimer() {
            var now = Math.floor(Date.now() / 1000);
            var d = expiryU - now;
            var el = document.getElementById('reservation-timer');
            if (!el) return;
            if (d <= 0) { el.textContent = '0h 0m (expiré)'; return; }
            var h = Math.floor(d / 3600);
            var m = Math.floor((d % 3600) / 60);
            el.textContent = h + 'h ' + m + 'm';
        }
        updateTimer();
        setInterval(updateTimer, 60000);
    })();
    </script>
    {% endif %}
{% endif %}

{{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}
<div class="form-group" style="margin-bottom: 30px;">
    {{ form_label(form.evenement, 'Événement Sélectionné', {'label_attr': {'style': 'display:block;margin-bottom:12px;font-weight:700;color: #2b2b2b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;'}}) }}
    {{ form_widget(form.evenement, {'attr': {'style': 'width:100%;padding:18px;border-radius:15px;border:1px solid #f0f0f0;background:#fcfcfc;font-family:inherit;pointer-events:none;color: #888;'}}) }}
    {{ form_errors(form.evenement) }}
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
    <div class="form-group" style="margin-bottom: 30px;">
        {{ form_label(form.dateReservation, 'Date & Heure Souhaitée', {'label_attr': {'style': 'display:block;margin-bottom:12px;font-weight:700;color: #2b2b2b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;'}}) }}
        {{ form_widget(form.dateReservation, {'attr': {'style': 'width:100%;padding:18px;border-radius:15px;border:1px solid #f0f0f0;font-family:inherit;background: white; outline: none; transition: border-color 0.3s;', 'onfocus': "this.style.borderColor='#C4704B'", 'onblur': "this.style.borderColor='#f0f0f0'"}}) }}
        {{ form_errors(form.dateReservation) }}
    </div>
    <div class="form-group" style="margin-bottom: 30px;">
        {{ form_label(form.nbPlaces, 'Nombre de Participants', {'label_attr': {'style': 'display:block;margin-bottom:12px;font-weight:700;color: #2b2b2b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;'}}) }}
        {{ form_widget(form.nbPlaces, {'attr': {'style': 'width:100%;padding:18px;border-radius:15px;border:1px solid #f0f0f0;font-family:inherit;background: white; outline: none; transition: border-color 0.3s;', 'onfocus': "this.style.borderColor='#C4704B'", 'onblur': "this.style.borderColor='#f0f0f0'", 'min': 1, 'max': 10}}) }}
        {{ form_errors(form.nbPlaces) }}
    </div>
</div>

<div class="form-group" style="margin-bottom: 40px;">
    {{ form_label(form.statut, 'Modalité de Réservation', {'label_attr': {'style': 'display:block;margin-bottom:20px;font-weight:700;color: #2b2b2b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;'}}) }}
    <div class="status-options" style="display: flex; flex-direction: column; gap: 15px;">
        {% for child in form.statut %}
            <label style="display: flex; align-items: flex-start; gap: 20px; padding: 25px; border: 2px solid #f5f5f5; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; background: white;" onmouseover="this.style.borderColor='#F0F0F0'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#f5f5f5'">
                <div style="margin-top: 5px;">
                    {{ form_widget(child, {'attr': {'style': 'width:22px; height: 22px; accent-color: #C4704B;', 'onclick': "const labels = document.querySelectorAll('.status-options label'); labels.forEach(l => l.style.borderColor='#f5f5f5'); this.closest('label').style.borderColor='#C4704B';"}}) }}
                </div>
                <div>
                    <span style="display: block; font-weight: 700; color: #2b2b2b; font-size: 1.1rem; margin-bottom: 5px;">{{ child.vars.label }}</span>
                    <small style="color: #888; line-height: 1.5; font-size: 0.9rem;">
                        {% if child.vars.value == 'en_attente' %}
                            Réservez sans payer aujourd'hui. Vous aurez <strong>3 heures</strong> pour confirmer votre paiement par la suite, passé ce délai elle sera libérée.
                        {% else %}
                            Garantissez votre place immédiatement via notre portail de <strong>paiement sécurisé</strong>. Recommandé pour les événements populaires.
                        {% endif %}
                    </small>
                </div>
            </label>
        {% endfor %}
    </div>
    {{ form_errors(form.statut) }}
</div>

<div style="display: flex; align-items: center; gap: 25px; margin-top: 40px; padding-top: 30px; border-top: 1px solid #f0f0f0;">
    <button type="submit" style="background: #2b2b2b; color: white; border: none; padding: 18px 40px; border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.background='#C4704B'; this.style.boxShadow='0 15px 35px rgba(196, 112, 75, 0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.background='#2b2b2b'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)';">
        {{ button_label|default('Enregistrer') }}
    </button>
    <a href="{{ path('app_evenement_index') }}" style="color: #666; text-decoration: none; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; transition: color 0.3s;" onmouseover="this.style.color='#2b2b2b'" onmouseout="this.style.color='#666'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        Annuler
    </a>
</div>
{{ form_end(form) }}

